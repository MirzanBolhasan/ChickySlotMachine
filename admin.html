<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Event Slot Machine - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            height: -webkit-fill-available;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 40px 20px;
            color: #2d3436;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 48px;
            animation: fadeIn 0.6s ease-out;
        }
        
        h1 {
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        h1 .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: clamp(14px, 2.5vw, 18px);
            color: #636e72;
            font-weight: 500;
        }
        
        /* Navigation */
        .nav {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            animation: fadeIn 0.8s ease-out;
        }
        
        .btn {
            padding: 12px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #2d3436;
            border: 2px solid #e1e8ed;
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }
        
        /* Status badge */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 32px;
            animation: fadeIn 1s ease-out;
        }
        
        .status.online {
            background: linear-gradient(135deg, #d4f8e8 0%, #b8f5d7 100%);
            color: #00b894;
        }
        
        .status.offline {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            color: #f39c12;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Card sections */
        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideUp 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        
        .card h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-icon {
            font-size: 28px;
        }
        
        /* Sound option card */
        .sound-option {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sound-option:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .sound-option.selected {
            background: #667eea;
            border-color: #667eea;
        }
        
        .sound-option.selected .option-name,
        .sound-option.selected .option-description {
            color: white;
        }
        
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .badge {
            background: #ffd700;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .option-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .play-btn-small {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Symbols grid */
        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
        }
        
        .symbol-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        
        .symbol-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        
        .symbol-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .symbol-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .symbol-name {
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .symbol-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            transition: border 0.2s;
        }
        
        .symbol-name-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .symbol-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .icon-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .icon-btn.upload {
            background: #3498db;
            color: white;
        }
        
        .icon-btn.upload:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .icon-btn.delete {
            background: #e74c3c;
            color: white;
        }
        
        .icon-btn.delete:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #667eea, #764ba2);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
        }
        
        .range-value {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
        }
        
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        
        .success-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        input[type="file"] {
            display: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: border 0.2s;
        }

        input[type="color"]:hover {
            border-color: #667eea;
        }

        .bg-type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .bg-type-btn {
            flex: 1;
            padding: 12px 20px;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #2d3436;
        }

        .bg-type-btn:hover {
            border-color: #cbd5e0;
        }

        .bg-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .bg-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .bg-preset-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e1e8ed;
            height: 120px;
        }

        .bg-preset-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .bg-preset-preview {
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bg-preset-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bg-preset-name {
            padding: 8px;
            background: white;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #2d3436;
        }

        .bg-preset-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .bg-preset-item:hover .bg-preset-actions {
            opacity: 1;
        }

        .preset-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .preset-action-btn.edit {
            background: #3498db;
            color: white;
        }

        .preset-action-btn.use {
            background: #00b894;
            color: white;
        }

        .preset-action-btn.delete {
            background: #e74c3c;
            color: white;
        }

        .preset-action-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé∞ <span class="text-gradient">Admin Panel</span></h1>
            <p class="subtitle">Manage your slot machine symbols, odds, and settings</p>
        </header>
        
        <div class="nav">
            <a href="spintest_modern.html" class="btn btn-primary">
                <span>üéÆ</span> View Slot Machine
            </a>
            <button class="btn btn-secondary" onclick="location.reload()">
                <span>üîÑ</span> Refresh
            </button>
        </div>
        
        <div id="server-status" class="status offline">
            <span class="status-dot"></span>
            <span>Checking server...</span>
        </div>
        
        <!-- Symbol Management -->
        <div class="card">
            <h2>
                <span class="card-icon">üé®</span>
                Slot Symbols
            </h2>
            <div class="symbols-grid" id="symbols-grid"></div>
        </div>
        
        <!-- Winning Probabilities -->
        <div class="card">
            <h2>
                <span class="card-icon">üé∞</span>
                Win Probabilities
            </h2>
            <p style="color: #636e72; margin-bottom: 24px; font-size: 15px;">Set the chance for each outcome. Total must equal 100%</p>
            
            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 14px; margin-bottom: 8px;">üèÜ Jackpot (3 Match) %</label>
                    <input type="number" id="three-match" min="0" max="100" value="10" 
                           style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; font-family: 'Poppins', sans-serif; text-align: left;"
                           oninput="updateProbabilities()">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 14px; margin-bottom: 8px;">üéÅ Win (2 Match) %</label>
                    <input type="number" id="two-match" min="0" max="100" value="25" 
                           style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; font-family: 'Poppins', sans-serif; text-align: left;"
                           oninput="updateProbabilities()">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 14px; margin-bottom: 8px;">üé´ Consolation (No Match) %</label>
                    <input type="number" id="no-match" min="0" max="100" value="65" 
                           style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; font-family: 'Poppins', sans-serif; text-align: left;"
                           oninput="updateProbabilities()">
                </div>
            </div>
            
            <div id="probability-warning" style="display: none; background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; font-weight: 600;">
                ‚ö†Ô∏è Total must equal 100%! Current total: <span id="total-percentage">100</span>%
            </div>
            
            <button class="btn btn-primary" onclick="saveSettings()">
                <span>üíæ</span> Save Probabilities
            </button>
        </div>
        
        <!-- Spin Animation Speed -->
        <div class="card">
            <h2>
                <span class="card-icon">‚ö°</span>
                Spin Animation
            </h2>
            <div class="form-group">
                <label>
                    Spin Duration: <span class="range-value" id="speed-value">2.0s</span>
                </label>
                <input type="range" id="spin-speed" min="1" max="10" step="0.1" value="2" 
                       oninput="document.getElementById('speed-value').textContent = this.value + 's'">
            </div>
            
            <button class="btn btn-primary" onclick="saveSettings()">
                <span>üíæ</span> Save Animation Speed
            </button>
        </div>

        <!-- Spin Sound Selection - NEW FEATURE -->
        <div class="card">
            <h2>
                <span class="card-icon">üîä</span>
                Spin Sound Effect
            </h2>
            <p style="color: #636e72; margin-bottom: 24px;">Choose the sound effect that plays during spinning</p>
            
            <div id="sound-options">
                <div class="sound-option" data-sound="1" onclick="selectSound(1)">
                    <div class="option-header">
                        <span class="option-name">üéµ Rapid Ticking</span>
                        <span class="badge">CLASSIC</span>
                    </div>
                    <p class="option-description">Fast clicking sounds that slow down as the reels stop</p>
                    <button class="play-btn-small" onclick="event.stopPropagation(); previewSound(1)">‚ñ∂ Preview</button>
                </div>
                
                <div class="sound-option" data-sound="2" onclick="selectSound(2)">
                    <div class="option-header">
                        <span class="option-name">üåÄ Smooth Whooshing</span>
                    </div>
                    <p class="option-description">Wheel-like spinning sound that gradually slows</p>
                    <button class="play-btn-small" onclick="event.stopPropagation(); previewSound(2)">‚ñ∂ Preview</button>
                </div>
                
                <div class="sound-option" data-sound="3" onclick="selectSound(3)">
                    <div class="option-header">
                        <span class="option-name">‚öôÔ∏è Mechanical Clicking</span>
                    </div>
                    <p class="option-description">Ratchet-like mechanical clicks</p>
                    <button class="play-btn-small" onclick="event.stopPropagation(); previewSound(3)">‚ñ∂ Preview</button>
                </div>
                
                <div class="sound-option" data-sound="4" onclick="selectSound(4)">
                    <div class="option-header">
                        <span class="option-name">üéÆ Electronic Beeping</span>
                    </div>
                    <p class="option-description">Arcade-style musical beeps</p>
                    <button class="play-btn-small" onclick="event.stopPropagation(); previewSound(4)">‚ñ∂ Preview</button>
                </div>
                
                <div class="sound-option" data-sound="5" onclick="selectSound(5)">
                    <div class="option-header">
                        <span class="option-name">ü•Å Drum Roll</span>
                    </div>
                    <p class="option-description">Building tension with drum roll effect</p>
                    <button class="play-btn-small" onclick="event.stopPropagation(); previewSound(5)">‚ñ∂ Preview</button>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveSoundSettings()" style="margin-top: 16px;">
                <span>üíæ</span> Save Sound Selection
            </button>
        </div>
        

        <!-- Layout Design Upload -->
        <div class="card">
            <h2>
                <span class="card-icon">üé≠</span>
                Event Layout Design
            </h2>
            <p style="color: #636e72; margin-bottom: 24px;">Upload custom layout designs for your event</p>
            
            <div class="form-grid" style="margin-bottom: 24px;">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 12px; display: block;">
                        üìä Prize Legend Layout (Top Box)
                    </label>
                    <button class="btn btn-primary" onclick="document.getElementById('legend-layout-upload').click()" style="width: 100%; margin-bottom: 12px;">
                        <span>üì§</span> Upload Legend Layout
                    </button>
                    <input type="file" id="legend-layout-upload" style="display: none" accept="image/*" onchange="uploadLayoutImage(event, 'legend')">
                    <div id="legend-preview" style="margin-top: 12px; border: 2px dashed #ddd; border-radius: 12px; padding: 16px; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                        <span style="color: #999;">No layout uploaded</span>
                    </div>
                    <button class="btn btn-secondary" onclick="removeLayoutImage('legend')" style="width: 100%; margin-top: 12px; display: none;" id="remove-legend-btn">
                        <span>üóëÔ∏è</span> Remove Legend Layout
                    </button>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 12px; display: block;">
                        üé∞ Slot Machine Layout (Bottom Box)
                    </label>
                    <button class="btn btn-primary" onclick="document.getElementById('machine-layout-upload').click()" style="width: 100%; margin-bottom: 12px;">
                        <span>üì§</span> Upload Machine Layout
                    </button>
                    <input type="file" id="machine-layout-upload" style="display: none" accept="image/*" onchange="uploadLayoutImage(event, 'machine')">
                    <div id="machine-preview" style="margin-top: 12px; border: 2px dashed #ddd; border-radius: 12px; padding: 16px; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                        <span style="color: #999;">No layout uploaded</span>
                    </div>
                    <button class="btn btn-secondary" onclick="removeLayoutImage('machine')" style="width: 100%; margin-top: 12px; display: none;" id="remove-machine-btn">
                        <span>üóëÔ∏è</span> Remove Machine Layout
                    </button>
                </div>
            </div>
            
            <div class="success-message" id="layout-success">
                <span>‚úì</span>
                <span>Layout saved successfully!</span>
            </div>
        </div>

        <!-- Background Customization -->
        <div class="card">
            <h2>
                <span class="card-icon">üñºÔ∏è</span>
                Background Design
            </h2>
            <p style="color: #636e72; margin-bottom: 24px;">Customize the background appearance</p>
            
            <div class="bg-type-selector">
                <button class="bg-type-btn active" onclick="showBgSection('color', this)">
                    üé® Solid Color
                </button>
                <button class="bg-type-btn" onclick="showBgSection('gradient', this)">
                    üåà Gradient
                </button>
                <button class="bg-type-btn" onclick="showBgSection('image', this)">
                    üñºÔ∏è Image
                </button>
            </div>
            
            <div id="bg-sections">
                <!-- Color Picker -->
                <div id="color-picker-section">
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Choose Background Color</label>
                        <input type="color" id="bg-color" value="#1a1a2e">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <button class="btn btn-primary" onclick="applyColorBackground()" style="flex: 1;">
                            <span>‚úì</span> Apply Color
                        </button>
                        <button class="btn btn-secondary" onclick="saveColorPreset()" style="flex: 1;">
                            <span>üíæ</span> Save as Preset
                        </button>
                    </div>
                </div>
                
                <!-- Gradient Picker -->
                <div id="gradient-picker-section" style="display: none; margin-top: 16px;">
                    <div class="form-grid" style="margin-bottom: 16px;">
                        <div class="form-group">
                            <label>Color 1</label>
                            <input type="color" id="gradient-color1" value="#1a1a2e" style="height: 50px;">
                        </div>
                        <div class="form-group">
                            <label>Color 2</label>
                            <input type="color" id="gradient-color2" value="#16213e" style="height: 50px;">
                        </div>
                        <div class="form-group">
                            <label>Color 3</label>
                            <input type="color" id="gradient-color3" value="#0f3460" style="height: 50px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="applyGradientBackground()" style="flex: 1;">
                            <span>‚úì</span> Apply Gradient
                        </button>
                        <button class="btn btn-secondary" onclick="saveGradientPreset()" style="flex: 1;">
                            <span>üíæ</span> Save as Preset
                        </button>
                    </div>
                </div>
                
                <!-- Image Upload -->
                <div id="image-upload-section" style="display: none; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="document.getElementById('bg-image-upload').click()" style="margin-bottom: 16px;">
                        <span>üì§</span> Upload Background Image
                    </button>
                    <input type="file" id="bg-image-upload" style="display: none" accept="image/*" onchange="uploadBackgroundImage(event)">
                </div>

                <!-- Saved Background Presets -->
                <div style="margin-top: 16px;" id="saved-presets-section">
                    <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">üíæ Saved Background Presets</h4>
                    <div class="bg-preset-grid" id="bg-presets-grid">
                        <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                            No saved presets yet.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Color Theme Section -->
            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">üé® Color Theme</h3>
            <div class="form-grid" style="margin-bottom: 24px;">
                <!-- Title Color -->
                <div class="form-group">
                    <label>üî§ Title Text Color</label>
                    <input type="color" id="title-color" value="#ffed4e" style="height: 50px;">
                </div>
                
                <!-- Subtitle Color -->
                <div class="form-group">
                    <label>üìù Subtitle Text Color</label>
                    <input type="color" id="subtitle-color" value="#ffffff" style="height: 50px;">
                </div>
                
                <!-- Prize Box Background -->
                <div class="form-group">
                    <label>üì¶ Prize Box Background</label>
                    <input type="color" id="prize-box-bg" value="#c084b3" style="height: 50px;">
                </div>
                
                <!-- Prize Box Text -->
                <div class="form-group">
                    <label>üèÜ Prize Box Text</label>
                    <input type="color" id="prize-box-text" value="#ffed4e" style="height: 50px;">
                </div>
                
                <!-- Slot Machine Box Background -->
                <div class="form-group">
                    <label>üé∞ Slot Machine Box</label>
                    <input type="color" id="slot-box-bg" value="#e8a0bf" style="height: 50px;">
                </div>
                
                <!-- Reel Inside Color -->
                <div class="form-group">
                    <label>üé° Reel Inside Color</label>
                    <input type="color" id="reel-bg" value="#1a1a2e" style="height: 50px;">
                </div>
                
                <!-- Spin Button Background -->
                <div class="form-group">
                    <label>üîò Spin Button Background</label>
                    <input type="color" id="spin-btn-bg" value="#ffed4e" style="height: 50px;">
                </div>
                
                <!-- Spin Button Text -->
                <div class="form-group">
                    <label>‚ö° Spin Button Text</label>
                    <input type="color" id="spin-btn-text" value="#000000" style="height: 50px;">
                </div>
                
                <!-- Instruction Text -->
                <div class="form-group">
                    <label>üí¨ Instruction Text</label>
                    <input type="color" id="instruction-text" value="#ffed4e" style="height: 50px;">
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <button class="btn btn-primary" onclick="applyColorTheme()" style="flex: 1;">
                    <span>‚úì</span> Apply Colors
                </button>
                <button class="btn btn-secondary" onclick="saveColorThemePreset()" style="flex: 1;">
                    <span>üíæ</span> Save as Preset
                </button>
                <button class="btn btn-secondary" onclick="resetColorTheme()">
                    <span>üîÑ</span> Reset to Default
                </button>
            </div>

            <!-- Saved Color Theme Presets -->
            <div style="margin-top: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">üíæ Saved Color Theme Presets</h4>
                <div class="bg-preset-grid" id="color-theme-presets-grid">
                    <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                        No saved color themes yet.
                    </div>
                </div>
            </div>
            
            <div class="success-message" id="theme-success">
                <span>‚úì</span>
                <span>Theme saved successfully!</span>
            </div>
            
            <div class="success-message" id="bg-success">
                <span>‚úì</span>
                <span>Background saved successfully!</span>
            </div>
        </div>
    </div>

    <script>
        let symbols = [];
        let serverAvailable = false;
        let savedBackgroundPresets = [];
        let savedColorThemes = [];
        let selectedSoundOption = 1; // Default to option 1

        const defaultColorTheme = {
            titleColor: '#ffed4e',
            subtitleColor: '#ffffff',
            prizeBoxBg: '#c084b3',
            prizeBoxText: '#ffed4e',
            slotBoxBg: '#e8a0bf',
            reelBg: '#1a1a2e',
            spinBtnBg: '#ffed4e',
            spinBtnText: '#000000',
            instructionText: '#ffed4e'
        };

        // Initialize symbols array
        async function initSymbols() {
            // Load from server only
            if (serverAvailable) {
                try {
                    const r = await fetch('/api/load/symbols');
                    const saved = await r.json();
                    if (saved && saved.length > 0) {
                        symbols = saved;
                        return;
                    }
                } catch(e) {
                    console.log('Failed to load symbols from server');
                }
            }
            
            // Use defaults if server fails
            symbols = [
                    { id: 1, name: 'Cherry', emoji: 'üçí', image: null },
                    { id: 2, name: 'Seven', emoji: '7Ô∏è‚É£', image: null },
                    { id: 3, name: 'Lemon', emoji: 'üçã', image: null },
                    { id: 4, name: 'Orange', emoji: 'üçä', image: null },
                    { id: 5, name: 'Star', emoji: '‚≠ê', image: null },
                    { id: 6, name: 'Diamond', emoji: 'üíé', image: null },
                    { id: 7, name: 'Bell', emoji: 'üîî', image: null },
                    { id: 8, name: 'Clover', emoji: 'üçÄ', image: null }
                ];
        }

        // Check if server is available
        async function checkServer() {
            try {
                const response = await fetch('/api/load/test', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                if (response.ok) {
                    serverAvailable = true;
                    document.getElementById('server-status').className = 'status online';
                    document.getElementById('server-status').innerHTML = '<span class="status-dot"></span><span>Server connected</span>';
                }
            } catch (e) {
                serverAvailable = false;
                document.getElementById('server-status').className = 'status offline';
                document.getElementById('server-status').innerHTML = '<span class="status-dot"></span><span>Offline mode (local storage only)</span>';
            }
        }

        // Save to server with error handling
        async function saveToServer(id, value) {
            if (!serverAvailable) return;
            
            try {
                await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, value })
                });
            } catch (e) {
                console.log('Server save failed, saved locally');
            }
        }

        // Render symbols
        function renderSymbols() {
            const grid = document.getElementById('symbols-grid');
            grid.innerHTML = '';
            
            symbols.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'symbol-card';
                
                const preview = document.createElement('div');
                preview.className = 'symbol-preview';
                if (symbol.image) {
                    const img = document.createElement('img');
                    img.src = symbol.image;
                    preview.appendChild(img);
                } else {
                    preview.textContent = symbol.emoji;
                }
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'symbol-name-input';
                nameInput.value = symbol.name;
                nameInput.onchange = () => updateSymbolName(index, nameInput.value);
                
                const actions = document.createElement('div');
                actions.className = 'symbol-actions';
                
                const uploadBtn = document.createElement('button');
                uploadBtn.className = 'icon-btn upload';
                uploadBtn.innerHTML = 'üì§ Upload';
                uploadBtn.onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => uploadSymbolImage(index, e);
                    input.click();
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'icon-btn delete';
                deleteBtn.innerHTML = 'üóëÔ∏è Delete';
                deleteBtn.onclick = () => deleteSymbol(index);
                
                actions.appendChild(uploadBtn);
                actions.appendChild(deleteBtn);
                
                card.appendChild(preview);
                card.appendChild(nameInput);
                card.appendChild(actions);
                
                grid.appendChild(card);
            });
        }

        // Update symbol name
        async function updateSymbolName(index, newName) {
            symbols[index].name = newName;
            await saveToServer('symbols', symbols);
        }

        // Upload symbol image
        async function uploadSymbolImage(index, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                symbols[index].image = e.target.result;
                await saveToServer('symbols', symbols);
                renderSymbols();
            };
            reader.readAsDataURL(file);
        }

        // Delete symbol
        async function deleteSymbol(index) {
            if (!confirm('Delete this symbol?')) return;
            if (symbols.length <= 3) {
                alert('You need at least 3 symbols!');
                return;
            }
            
            symbols.splice(index, 1);
            await saveToServer('symbols', symbols);
            renderSymbols();
        }

        // Update probabilities display
        function updateProbabilities() {
            const three = parseInt(document.getElementById('three-match').value) || 0;
            const two = parseInt(document.getElementById('two-match').value) || 0;
            const noMatch = parseInt(document.getElementById('no-match').value) || 0;
            
            const total = three + two + noMatch;
            
            // Show/hide warning based on total
            const warning = document.getElementById('probability-warning');
            const totalSpan = document.getElementById('total-percentage');
            
            if (total !== 100) {
                warning.style.display = 'block';
                totalSpan.textContent = total;
            } else {
                warning.style.display = 'none';
            }
        }

        // Save all settings
        async function saveSettings() {
            const three = parseInt(document.getElementById('three-match').value) || 0;
            const two = parseInt(document.getElementById('two-match').value) || 0;
            const noMatch = parseInt(document.getElementById('no-match').value) || 0;
            const spinSpeed = document.getElementById('spin-speed').value;
            
            // Validate probabilities total 100%
            const total = three + two + noMatch;
            if (total !== 100) {
                alert(`Probabilities must total 100%! Current total: ${total}%`);
                return;
            }
            
            const probabilities = {
                THREE_MATCH: three,
                TWO_MATCH: two,
                NO_MATCH: noMatch
            };
            
            // Save locally
            
            // Save to server
            await saveToServer('probabilities', probabilities);
            await saveToServer('spinSpeed', spinSpeed);
            await saveToServer('symbols', symbols);
            
            showSuccessMessage('general');
        }

        // NEW: Sound selection functions
        function selectSound(soundNumber) {
            selectedSoundOption = soundNumber;
            
            // Update UI
            document.querySelectorAll('.sound-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelector(`[data-sound="${soundNumber}"]`).classList.add('selected');
        }

        function previewSound(soundNumber) {
            const spinDuration = parseFloat(document.getElementById('spin-speed').value);
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const totalDuration = spinDuration + 1.2;
            
            switch(soundNumber) {
                case 1:
                    playOption1(audioCtx, spinDuration, totalDuration);
                    break;
                case 2:
                    playOption2(audioCtx, spinDuration, totalDuration);
                    break;
                case 3:
                    playOption3(audioCtx, spinDuration, totalDuration);
                    break;
                case 4:
                    playOption4(audioCtx, spinDuration, totalDuration);
                    break;
                case 5:
                    playOption5(audioCtx, spinDuration, totalDuration);
                    break;
            }
        }

        async function saveSoundSettings() {
            // Save selected sound option
            await saveToServer('spinSound', selectedSoundOption);
            showSuccessMessage('general');
        }

        // Sound preview functions (from testsound.html)
        function playOption1(audioCtx, spinDuration, totalDuration) {
            const tickCount = Math.max(30, Math.floor(spinDuration * 15));
            
            for (let i = 0; i < tickCount; i++) {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 1200 + (Math.random() * 200);
                oscillator.type = 'square';
                
                const progress = i / tickCount;
                const delay = progress * progress * totalDuration;
                
                const startTime = audioCtx.currentTime + delay;
                gainNode.gain.setValueAtTime(0.15, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.05);
            }
        }
        
        function playOption2(audioCtx, spinDuration, totalDuration) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + totalDuration);
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime + totalDuration - 0.3);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + totalDuration);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + totalDuration);
        }
        
        function playOption3(audioCtx, spinDuration, totalDuration) {
            const clickCount = Math.floor(spinDuration * 20);
            
            for (let i = 0; i < clickCount; i++) {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                const filterNode = audioCtx.createBiquadFilter();
                
                oscillator.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                filterNode.type = 'bandpass';
                filterNode.frequency.value = 3000;
                
                oscillator.type = 'square';
                oscillator.frequency.value = 100;
                
                const progress = i / clickCount;
                const delay = Math.pow(progress, 1.5) * totalDuration;
                
                const startTime = audioCtx.currentTime + delay;
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.03);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.03);
            }
        }
        
        function playOption4(audioCtx, spinDuration, totalDuration) {
            const beepCount = Math.floor(spinDuration * 12);
            const frequencies = [440, 493, 523, 587, 659];
            
            for (let i = 0; i < beepCount; i++) {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = frequencies[i % frequencies.length];
                oscillator.type = 'sine';
                
                const progress = i / beepCount;
                const delay = Math.pow(progress, 2) * totalDuration;
                
                const startTime = audioCtx.currentTime + delay;
                gainNode.gain.setValueAtTime(0.18, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.08);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.08);
            }
        }
        
        function playOption5(audioCtx, spinDuration, totalDuration) {
            const hitCount = Math.floor(spinDuration * 25);
            
            for (let i = 0; i < hitCount; i++) {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                const filterNode = audioCtx.createBiquadFilter();
                
                oscillator.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                filterNode.type = 'lowpass';
                filterNode.frequency.value = 200 + (Math.random() * 100);
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.value = 80 + (Math.random() * 20);
                
                const progress = i / hitCount;
                const delay = Math.pow(progress, 0.8) * totalDuration;
                
                const startTime = audioCtx.currentTime + delay;
                gainNode.gain.setValueAtTime(0.25, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.04);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.04);
            }
        }

        // Show success message
        function showSuccessMessage(id) {
            let messageEl;
            if (id === 'general') {
                messageEl = document.createElement('div');
                messageEl.className = 'success-message';
                messageEl.innerHTML = '<span>‚úì</span><span>Settings saved successfully!</span>';
                document.body.appendChild(messageEl);
                setTimeout(() => messageEl.classList.add('show'), 10);
                setTimeout(() => {
                    messageEl.classList.remove('show');
                    setTimeout(() => messageEl.remove(), 400);
                }, 3000);
            } else {
                messageEl = document.getElementById(id + '-success');
                messageEl.classList.add('show');
                setTimeout(() => messageEl.classList.remove('show'), 3000);
            }
        }

        // Background section switching
        function showBgSection(type, clickedBtn) {
            // Update button states
            document.querySelectorAll('.bg-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Use the passed element (avoids unreliable window.event.target)
            if (clickedBtn) clickedBtn.classList.add('active');
            
            // Hide all sections
            document.getElementById('color-picker-section').style.display = 'none';
            document.getElementById('gradient-picker-section').style.display = 'none';
            document.getElementById('image-upload-section').style.display = 'none';
            
            // Show selected section
            if (type === 'color') {
                document.getElementById('color-picker-section').style.display = 'block';
            } else if (type === 'gradient') {
                document.getElementById('gradient-picker-section').style.display = 'block';
            } else if (type === 'image') {
                document.getElementById('image-upload-section').style.display = 'block';
            }
        }

        // Apply solid color background
        async function applyColorBackground() {
            const color = document.getElementById('bg-color').value;
            const bgData = {
                type: 'color',
                value: color  // Changed from 'color' to 'value'
            };
            
            if (serverAvailable) {
                await saveToServer('background', bgData);
            }
            
            showSuccessMessage('bg');
        }

        // Apply gradient background
        async function applyGradientBackground() {
            const color1 = document.getElementById('gradient-color1').value;
            const color2 = document.getElementById('gradient-color2').value;
            const color3 = document.getElementById('gradient-color3').value;
            
            const gradientValue = `linear-gradient(135deg, ${color1} 0%, ${color2} 50%, ${color3} 100%)`;
            
            const bgData = {
                type: 'gradient',
                value: gradientValue  // Changed to 'value' with gradient string
            };
            
            if (serverAvailable) {
                await saveToServer('background', bgData);
            }
            
            showSuccessMessage('bg');
        }

        // Upload background image
        async function uploadBackgroundImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const bgData = {
                    type: 'image',
                    value: e.target.result  // Changed from 'image' to 'value'
                };
                
                if (serverAvailable) {
                    await saveToServer('background', bgData);
                }
                
                showSuccessMessage('bg');
            };
            reader.readAsDataURL(file);
        }

        // Save color preset
        async function saveColorPreset() {
            const color = document.getElementById('bg-color').value;
            const name = prompt('Enter preset name:');
            if (!name) return;
            
            savedBackgroundPresets.push({
                name: name,
                type: 'color',
                value: color  // Changed from 'color' to 'value'
            });
            
            if (serverAvailable) {
                await saveToServer('backgroundPresets', savedBackgroundPresets);
            }
            
            renderBackgroundPresets();
        }

        // Save gradient preset
        async function saveGradientPreset() {
            const color1 = document.getElementById('gradient-color1').value;
            const color2 = document.getElementById('gradient-color2').value;
            const color3 = document.getElementById('gradient-color3').value;
            const name = prompt('Enter preset name:');
            if (!name) return;
            
            const gradientValue = `linear-gradient(135deg, ${color1} 0%, ${color2} 50%, ${color3} 100%)`;
            
            savedBackgroundPresets.push({
                name: name,
                type: 'gradient',
                value: gradientValue  // Changed to 'value' with gradient string
            });
            
            if (serverAvailable) {
                await saveToServer('backgroundPresets', savedBackgroundPresets);
            }
            
            renderBackgroundPresets();
        }

        // Render background presets
        function renderBackgroundPresets() {
            const grid = document.getElementById('bg-presets-grid');
            
            if (savedBackgroundPresets.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">No saved presets yet.</div>';
                return;
            }
            
            grid.innerHTML = '';
            savedBackgroundPresets.forEach((preset, index) => {
                const item = document.createElement('div');
                item.className = 'bg-preset-item';
                
                const preview = document.createElement('div');
                preview.className = 'bg-preset-preview';
                
                if (preset.type === 'color') {
                    preview.style.background = preset.value;  // Changed from preset.color
                } else if (preset.type === 'gradient') {
                    preview.style.background = preset.value;  // Changed from template literal
                } else if (preset.type === 'image') {
                    const img = document.createElement('img');
                    img.src = preset.value;  // Changed from preset.image
                    preview.appendChild(img);
                }
                
                const name = document.createElement('div');
                name.className = 'bg-preset-name';
                name.textContent = preset.name;
                
                const actions = document.createElement('div');
                actions.className = 'bg-preset-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'preset-action-btn edit';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.onclick = () => editBackgroundPreset(index);
                
                const useBtn = document.createElement('button');
                useBtn.className = 'preset-action-btn use';
                useBtn.innerHTML = '‚úì';
                useBtn.onclick = () => applyBackgroundPreset(index);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'preset-action-btn delete';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.onclick = () => deleteBackgroundPreset(index);
                
                actions.appendChild(editBtn);
                actions.appendChild(useBtn);
                actions.appendChild(deleteBtn);
                
                item.appendChild(preview);
                item.appendChild(name);
                item.appendChild(actions);
                
                grid.appendChild(item);
            });
        }

        async function editBackgroundPreset(index) {
            const preset = savedBackgroundPresets[index];
            const newName = prompt('Edit preset name:', preset.name);
            if (newName !== null && newName.trim() !== '') {
                preset.name = newName.trim();
                if (serverAvailable) {
                    await saveToServer('backgroundPresets', savedBackgroundPresets);
                }
                renderBackgroundPresets();
            }
        }

        async function applyBackgroundPreset(index) {
            const preset = savedBackgroundPresets[index];
            if (serverAvailable) {
                await saveToServer('background', preset);
            }
            showSuccessMessage('bg');
        }

        async function deleteBackgroundPreset(index) {
            if (!confirm('Delete this preset?')) return;
            savedBackgroundPresets.splice(index, 1);
            if (serverAvailable) {
                await saveToServer('backgroundPresets', savedBackgroundPresets);
            }
            renderBackgroundPresets();
        }

        // Color Theme functions
        async function applyColorTheme() {
            const themeData = {
                titleColor: document.getElementById('title-color').value,
                subtitleColor: document.getElementById('subtitle-color').value,
                prizeBoxBg: document.getElementById('prize-box-bg').value,
                prizeBoxText: document.getElementById('prize-box-text').value,
                slotBoxBg: document.getElementById('slot-box-bg').value,
                reelBg: document.getElementById('reel-bg').value,
                spinBtnBg: document.getElementById('spin-btn-bg').value,
                spinBtnText: document.getElementById('spin-btn-text').value,
                instructionText: document.getElementById('instruction-text').value
            };

            
            if (serverAvailable) {
                await saveToServer('colorTheme', themeData);
            }

            showThemeSuccess();
        }

        async function saveColorThemePreset() {
            const name = prompt('Enter color theme preset name:');
            if (!name) return;

            const themeData = {
                name: name,
                titleColor: document.getElementById('title-color').value,
                subtitleColor: document.getElementById('subtitle-color').value,
                prizeBoxBg: document.getElementById('prize-box-bg').value,
                prizeBoxText: document.getElementById('prize-box-text').value,
                slotBoxBg: document.getElementById('slot-box-bg').value,
                reelBg: document.getElementById('reel-bg').value,
                spinBtnBg: document.getElementById('spin-btn-bg').value,
                spinBtnText: document.getElementById('spin-btn-text').value,
                instructionText: document.getElementById('instruction-text').value
            };

            savedColorThemes.push(themeData);
            
            if (serverAvailable) {
                await saveToServer('colorThemes', savedColorThemes);
            }

            renderColorThemePresets();
        }

        async function resetColorTheme() {
            document.getElementById('title-color').value = defaultColorTheme.titleColor;
            document.getElementById('subtitle-color').value = defaultColorTheme.subtitleColor;
            document.getElementById('prize-box-bg').value = defaultColorTheme.prizeBoxBg;
            document.getElementById('prize-box-text').value = defaultColorTheme.prizeBoxText;
            document.getElementById('slot-box-bg').value = defaultColorTheme.slotBoxBg;
            document.getElementById('reel-bg').value = defaultColorTheme.reelBg;
            document.getElementById('spin-btn-bg').value = defaultColorTheme.spinBtnBg;
            document.getElementById('spin-btn-text').value = defaultColorTheme.spinBtnText;
            document.getElementById('instruction-text').value = defaultColorTheme.instructionText;

            await applyColorTheme();
        }

        function renderColorThemePresets() {
            const grid = document.getElementById('color-theme-presets-grid');
            
            if (savedColorThemes.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">No saved color themes yet.</div>';
                return;
            }
            
            grid.innerHTML = '';
            savedColorThemes.forEach((theme, index) => {
                const item = document.createElement('div');
                item.className = 'bg-preset-item';
                
                const preview = document.createElement('div');
                preview.className = 'bg-preset-preview';
                preview.style.background = `linear-gradient(135deg, ${theme.titleColor} 0%, ${theme.spinBtnBg} 50%, ${theme.prizeBoxBg} 100%)`;
                
                const name = document.createElement('div');
                name.className = 'bg-preset-name';
                name.textContent = theme.name;
                
                const actions = document.createElement('div');
                actions.className = 'bg-preset-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'preset-action-btn edit';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.onclick = () => editColorThemePreset(index);
                
                const useBtn = document.createElement('button');
                useBtn.className = 'preset-action-btn use';
                useBtn.innerHTML = '‚úì';
                useBtn.onclick = () => applyColorThemePreset(index);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'preset-action-btn delete';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.onclick = () => deleteColorThemePreset(index);
                
                actions.appendChild(editBtn);
                actions.appendChild(useBtn);
                actions.appendChild(deleteBtn);
                item.appendChild(actions);
                
                item.appendChild(preview);
                item.appendChild(name);
                
                grid.appendChild(item);
            });
        }

        async function editColorThemePreset(index) {
            const theme = savedColorThemes[index];
            
            // Load colors into pickers
            document.getElementById('title-color').value = theme.titleColor;
            document.getElementById('subtitle-color').value = theme.subtitleColor;
            document.getElementById('prize-box-bg').value = theme.prizeBoxBg;
            document.getElementById('prize-box-text').value = theme.prizeBoxText;
            document.getElementById('slot-box-bg').value = theme.slotBoxBg;
            document.getElementById('reel-bg').value = theme.reelBg || '#1a1a2e';
            document.getElementById('spin-btn-bg').value = theme.spinBtnBg;
            document.getElementById('spin-btn-text').value = theme.spinBtnText;
            document.getElementById('instruction-text').value = theme.instructionText;

            const newName = prompt('Edit theme name:', theme.name);
            if (newName !== null && newName.trim() !== '') {
                theme.name = newName.trim();
                if (serverAvailable) {
                    await saveToServer('colorThemes', savedColorThemes);
                }
                renderColorThemePresets();
            }
        }

        async function applyColorThemePreset(index) {
            const theme = savedColorThemes[index];
            
            // Apply to local storage and server
            const themeData = {
                titleColor: theme.titleColor,
                subtitleColor: theme.subtitleColor,
                prizeBoxBg: theme.prizeBoxBg,
                prizeBoxText: theme.prizeBoxText,
                slotBoxBg: theme.slotBoxBg,
                reelBg: theme.reelBg || '#1a1a2e',
                spinBtnBg: theme.spinBtnBg,
                spinBtnText: theme.spinBtnText,
                instructionText: theme.instructionText
            };

            
            if (serverAvailable) {
                await saveToServer('colorTheme', themeData);
            }

            showThemeSuccess();
        }

        async function deleteColorThemePreset(index) {
            if (!confirm('Delete this color theme?')) return;
            
            savedColorThemes.splice(index, 1);
            if (serverAvailable) {
                await saveToServer('colorThemes', savedColorThemes);
            }
            renderColorThemePresets();
        }

        function showThemeSuccess() {
            const successMsg = document.getElementById('theme-success');
            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 3000);
        }

        async function loadColorThemePresets() {
            // Load color theme list from server only
            let colorThemes = null;
            if (serverAvailable) {
                try { const r = await fetch('/api/load/colorThemes'); colorThemes = await r.json(); } catch(e) {}
            }
            if (colorThemes && Array.isArray(colorThemes)) {
                savedColorThemes = colorThemes;
                renderColorThemePresets();
            }

            // Load active color theme from server only
            let activeTheme = null;
            if (serverAvailable) {
                try { const r = await fetch('/api/load/colorTheme'); activeTheme = await r.json(); } catch(e) {}
            }
            if (activeTheme) {
                document.getElementById('title-color').value = activeTheme.titleColor || defaultColorTheme.titleColor;
                document.getElementById('subtitle-color').value = activeTheme.subtitleColor || defaultColorTheme.subtitleColor;
                document.getElementById('prize-box-bg').value = activeTheme.prizeBoxBg || defaultColorTheme.prizeBoxBg;
                document.getElementById('prize-box-text').value = activeTheme.prizeBoxText || defaultColorTheme.prizeBoxText;
                document.getElementById('slot-box-bg').value = activeTheme.slotBoxBg || defaultColorTheme.slotBoxBg;
                document.getElementById('spin-btn-bg').value = activeTheme.spinBtnBg || defaultColorTheme.spinBtnBg;
                document.getElementById('spin-btn-text').value = activeTheme.spinBtnText || defaultColorTheme.spinBtnText;
                document.getElementById('instruction-text').value = activeTheme.instructionText || defaultColorTheme.instructionText;
            }
        }
        
        // Initialize
        window.onload = async () => {
            await checkServer();
            await initSymbols();
            renderSymbols();
            
            // Load probabilities from server first (never overwrite with hardcoded defaults)
            let loadedProbs = { THREE_MATCH: 10, TWO_MATCH: 25, NO_MATCH: 65 };
            if (serverAvailable) {
                try {
                    const r = await fetch('/api/load/probabilities');
                    const sp = await r.json();
                    if (sp && typeof sp === 'object' && 'THREE_MATCH' in sp) loadedProbs = sp;
                } catch(e) {}
            }
            
            document.getElementById('three-match').value = loadedProbs.THREE_MATCH;
            document.getElementById('two-match').value = loadedProbs.TWO_MATCH;
            document.getElementById('no-match').value = loadedProbs.NO_MATCH;
            
            // Load spin speed from server only
            let savedSpeed = null;
            if (serverAvailable) {
                try { const r = await fetch('/api/load/spinSpeed'); savedSpeed = await r.json(); } catch(e) {}
            }
            if (savedSpeed) {
                document.getElementById('spin-speed').value = savedSpeed;
                document.getElementById('speed-value').textContent = savedSpeed + 's';
            }
            
            // Load sound selection from server only
            let savedSound = null;
            if (serverAvailable) {
                try { const r = await fetch('/api/load/spinSound'); savedSound = await r.json(); } catch(e) {}
            }
            if (savedSound !== null && savedSound !== undefined) {
                selectedSoundOption = parseInt(savedSound);
                selectSound(selectedSoundOption);
            } else {
                selectSound(1); // default
            }
            
            // Load existing layouts
            loadLayoutPreviews();
            
            // Load background presets from server only
            if (serverAvailable) {
                try {
                    const r = await fetch('/api/load/backgroundPresets');
                    const sp = await r.json();
                    if (sp && Array.isArray(sp)) savedBackgroundPresets = sp;
                } catch(e) {}
            }
            renderBackgroundPresets();
            
            // Load saved color theme presets
            await loadColorThemePresets();
        };

        
        // Layout Upload Functions
        async function uploadLayoutImage(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Image = e.target.result;
                
                // Save to server
                try {
                    await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: `layout-${type}`,
                            value: base64Image
                        })
                    });
                } catch (e) {
                    console.log('Server save failed');
                }
                
                // Update preview
                updateLayoutPreview(type, base64Image);
                
                // Show success message
                showSuccessMessage('layout');
            };
            reader.readAsDataURL(file);
        }
        
        function updateLayoutPreview(type, base64Image) {
            const previewDiv = document.getElementById(`${type}-preview`);
            const removeBtn = document.getElementById(`remove-${type}-btn`);
            
            if (base64Image) {
                previewDiv.innerHTML = `<img src="${base64Image}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">`;
                removeBtn.style.display = 'block';
            } else {
                previewDiv.innerHTML = '<span style="color: #999;">No layout uploaded</span>';
                removeBtn.style.display = 'none';
            }
        }
        
        async function removeLayoutImage(type) {
            if (!confirm('Remove this layout design?')) return;
            
            // Remove from server
            try {
                await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: `layout-${type}`,
                        value: null
                    })
                });
            } catch (e) {
                console.log('Server remove failed');
            }
            
            // Update preview
            updateLayoutPreview(type, null);
        }
        

        
        
        async function loadLayoutPreviews() {
            // Load legend layout from server
            try {
                const r = await fetch('/api/load/layout-legend');
                const legendLayout = await r.json();
                if (legendLayout) {
                    updateLayoutPreview('legend', legendLayout);
                }
            } catch(e) {}
            
            // Load machine layout from server
            try {
                const r = await fetch('/api/load/layout-machine');
                const machineLayout = await r.json();
                if (machineLayout) {
                    updateLayoutPreview('machine', machineLayout);
                }
            } catch(e) {}
        }

        // Initialize all forms on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadLayoutPreviews();
        });

    </script>
</body>
</html>