<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="color-scheme" content="light">
    <title>Chickilicious Lucky Spin - Win Your Prize!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        ::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

        :root {
            --primary-color: #ffd700;
            --primary-light: #ffed4e;
            --primary-rgb: 255, 215, 0;
            --reel-bg-color: rgba(20, 20, 40, 0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
            background: linear-gradient(135deg, #f5a3b8 0%, #e88da5 50%, #dd7a93 100%);
            min-height: 100vh;
            max-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            margin: 0;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(var(--primary-rgb), 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 107, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(78, 205, 196, 0.03) 0%, transparent 50%);
            animation: particleFloat 20s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        .container {
            max-width: 100%;
            width: 100%;
            max-height: 98vh;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            animation: fadeInDown 0.8s ease-out;
            display: none;
        }

        .header h1 {
            font-size: clamp(42px, 8vw, 64px);
            font-weight: 900;
            letter-spacing: 2px;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .animated-logo {
            display: block;
            font-size: clamp(48px, 10vw, 80px);
            margin-bottom: 8px;
        }
        .animated-logo .char {
            display: inline-block;
            will-change: transform;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 50%, var(--primary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 8px rgba(var(--primary-rgb), 0.4));
        }

        .lucky-spin-text { display: block; }
        .lucky-spin-text .emoji {
            background: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: unset;
            background-clip: unset;
            filter: none;
        }
        .lucky-spin-text .text {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 50%, var(--primary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 8px rgba(var(--primary-rgb), 0.4));
        }

        .header p {
            font-size: clamp(16px, 3vw, 22px);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        /* Prize Legend */
        .prize-legend {
            position: relative;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 32px;
            margin: 24px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-radius: 20px;
            border: 1px solid rgba(var(--primary-rgb), 0.2);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .legend-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3); }
        .legend-symbols { display: flex; align-items: center; gap: 4px; }
        .legend-symbol { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 36px; }
        .legend-symbol img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .legend-arrow { color: var(--primary-color); font-size: 18px; font-weight: bold; }
        .legend-prize { color: var(--primary-color); font-size: clamp(14px, 2.5vw, 18px); font-weight: 700; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }

        @media (max-width: 768px) {
            .prize-legend { gap: 16px; }
            .legend-item { padding: 10px 16px; gap: 8px; }
            .legend-symbol { width: 40px; height: 40px; font-size: 30px; }
        }

        /* Full Template Mode */
        body.template-mode { background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; }
        body.template-mode .header { display: none; }
        body.template-mode .prize-legend { display: none; }
        body.template-mode .slot-machine { background: transparent; backdrop-filter: none; box-shadow: none; border: none; padding: 50px 20px; }
        body.template-mode .container { max-width: 100%; }

        /* Slot Machine Card */
        .slot-machine {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.6) 0%, rgba(255, 160, 180, 0.5) 100%);
            border-radius: 32px;
            padding: clamp(20px, 3vh, 50px) clamp(15px, 2.5vw, 40px);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            animation: fadeInUp 0.8s ease-out;
            width: 100%;
            max-height: 98vh;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        @media (min-width: 1200px) { .slot-machine { border-radius: 20px; } .reels-container { border-radius: 20px; } body { padding: 8px; } }
        @media (min-width: 1920px) { .slot-machine { border-radius: 12px; } .reels-container { border-radius: 12px; } body { padding: 12px; } }
        @media (min-width: 2560px) { .slot-machine { border-radius: 8px; } .reels-container { border-radius: 8px; } body { padding: 15px; } }

        /* Layout Design Overlays */
        .prize-legend::before, .slot-machine::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 10;
            border-radius: inherit;
        }
        .prize-legend.has-layout::before { background-image: var(--legend-layout); }
        .slot-machine.has-layout::before { background-image: var(--machine-layout); }

        .machine-body-overlay {
            position: absolute;
            inset: 0;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            z-index: 50;
            border-radius: inherit;
            display: none;
        }
        .machine-body-overlay.active { display: block; }

        .slot-machine::before { top: -10px; left: -10px; border-right: none; border-bottom: none; }
        .slot-machine::after { bottom: -10px; right: -10px; border-left: none; border-top: none; }

        /* Reels Container */
        .reels-container {
            display: flex;
            gap: clamp(30px, 5vw, 80px);
            margin-bottom: clamp(20px, 3vh, 40px);
            padding: clamp(24px, 3vw, 50px);
            background: linear-gradient(135deg, rgba(156, 89, 101, 0.9) 0%, rgba(139, 82, 94, 0.8) 100%);
            border-radius: 24px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3), 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .reel {
            flex: 1;
            height: clamp(250px, 35vh, 500px);
            border-radius: 16px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5), 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
            overflow: hidden;
            background: var(--reel-bg-color);
            perspective: 600px;
            perspective-origin: 50% 50%;
        }

        .reel::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                rgba(255,255,255,0.10) 0%,
                transparent 20%,
                transparent 80%,
                rgba(0,0,0,0.15) 100%
            );
            pointer-events: none;
            z-index: 20;
            border-radius: 14px;
        }

        .reel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -10%;
            right: -10%;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(var(--primary-rgb), 0.9), transparent);
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 30;
            box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.8), 0 0 40px rgba(var(--primary-rgb), 0.4);
            animation: goldenLinePulse 2s ease-in-out infinite;
        }

        @keyframes goldenLinePulse {
            0%, 100% { opacity: 0.8; box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.9), 0 0 40px rgba(var(--primary-rgb), 0.4); height: 3px; }
            50% { opacity: 1; box-shadow: 0 0 30px rgba(var(--primary-rgb), 1), 0 0 60px rgba(var(--primary-rgb), 0.6), 0 0 80px rgba(var(--primary-rgb), 0.3); height: 4px; }
        }

        .reel.active-spin::after { animation: goldenLinePulseFast 0.5s ease-in-out infinite; }
        @keyframes goldenLinePulseFast {
            0%, 100% { opacity: 0.9; box-shadow: 0 0 25px rgba(var(--primary-rgb), 1), 0 0 50px rgba(var(--primary-rgb), 0.5); height: 3px; }
            50% { opacity: 1; box-shadow: 0 0 35px rgba(var(--primary-rgb), 1), 0 0 70px rgba(var(--primary-rgb), 0.7), 0 0 100px rgba(var(--primary-rgb), 0.4); height: 5px; }
        }

        .reel.active-spin {
            border-color: rgba(244, 224, 77, 0.6);
            box-shadow:
                inset 0 2px 10px rgba(0, 0, 0, 0.5),
                0 2px 10px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(244, 224, 77, 0.4);
        }

        .reel.reveal-flash { animation: revealFlash 0.5s ease-out; }
        @keyframes revealFlash {
            0% { box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 2px 10px rgba(0,0,0,0.3), 0 0 40px rgba(244,224,77,0.9), 0 0 60px rgba(244,224,77,0.6); }
            100% { box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 2px 10px rgba(0,0,0,0.3); }
        }

        .reel-mask {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                to bottom,
                rgba(14, 10, 22, 0.95) 0%,
                rgba(14, 10, 22, 0.65) 18%,
                transparent 32%,
                transparent 68%,
                rgba(14, 10, 22, 0.65) 82%,
                rgba(14, 10, 22, 0.95) 100%
            );
            pointer-events: none;
            z-index: 15;
            border-radius: 14px;
        }

        .reel-glass {
            position: absolute;
            inset: 0;
            background: linear-gradient(160deg, rgba(255,255,255,0.06) 0%, transparent 50%);
            border-radius: 14px;
            pointer-events: none;
            z-index: 25;
        }

        .reel-strip {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 0;
            transform-style: preserve-3d;
            transform: rotateX(0deg);
            will-change: transform;
        }

        .reel-symbol {
            position: absolute;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
            -webkit-font-smoothing: antialiased;
            will-change: transform;
        }

        .reel-symbol img {
            width: 78%;
            height: 78%;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
            transition: filter 0.3s ease;
        }

        .reel-symbol.winning { animation: winningPulse 1s ease-in-out; z-index: 10; }
        .reel-symbol.winning img {
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8))
                    drop-shadow(0 0 30px rgba(255, 215, 0, 0.6))
                    drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
        }
        @keyframes winningPulse {
            0% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.15); }
            75% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }

        /* Info Display */
        .info-display {
            text-align: center;
            margin-bottom: clamp(18px, 2.5vh, 36px);
            padding: clamp(14px, 2vh, 28px);
            background: rgba(255, 182, 193, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(255, 192, 203, 0.4);
        }
        .info-display p {
            color: #f4e04d;
            font-size: clamp(18px, 3vh, 42px);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Spin Button */
        .spin-button {
            width: 100%;
            padding: clamp(18px, 3vh, 45px);
            border-radius: 20px;
            background: linear-gradient(135deg, #f4e04d 0%, #e8d636 100%);
            border: none;
            cursor: pointer;
            font-size: clamp(24px, 4.5vh, 56px);
            font-weight: 900;
            color: #000000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px rgba(244, 224, 77, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        .spin-button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .spin-button:hover:not(.disabled) { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(244, 224, 77, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        .spin-button:hover:not(.disabled)::before { left: 100%; }
        .spin-button:active:not(.disabled) { transform: translateY(-1px); box-shadow: 0 5px 20px rgba(244, 224, 77, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        .spin-button.disabled { opacity: 0.6; cursor: not-allowed; background: linear-gradient(135deg, #888 0%, #aaa 100%); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important; }
        .spin-button .spinner-icon { display: inline-block; margin-left: 8px; animation: rotate 1s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Win Popup */
        .win-popup {
            position: relative;
            width: 100%;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            padding: 0;
            margin-bottom: 0;
            transition: max-height 0.45s cubic-bezier(0.34, 1.4, 0.64, 1), opacity 0.35s ease, padding 0.35s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px 20px 0 0;
            border: 3px solid #f4e04d;
            border-bottom: none;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: clamp(8px, 1.2vh, 16px);
            z-index: 100;
        }
        .win-popup.show { max-height: clamp(140px, 22vh, 280px); opacity: 1; pointer-events: auto; padding: clamp(16px, 2.5vh, 32px) clamp(20px, 3vw, 40px); }
        .win-popup > * { opacity: 0; transition: opacity 0.3s ease 0.15s; }
        .win-popup.show > * { opacity: 1; }
        .win-popup .emoji { font-size: clamp(40px, 7vh, 100px); display: flex; align-items: center; justify-content: center; flex-shrink: 0; width: clamp(50px, 8vh, 110px); height: clamp(50px, 8vh, 110px); animation: bounce 0.6s ease-in-out; margin-bottom: clamp(4px, 0.6vh, 8px); }
        .win-popup .emoji img { max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 3px 8px rgba(0,0,0,0.2)); }
        @keyframes bounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-12px) scale(1.05); } }
        .win-popup-content { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: clamp(4px, 0.6vh, 10px); width: 100%; }
        .win-popup h1 { font-size: clamp(24px, 4.8vh, 64px); font-weight: 900; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; letter-spacing: 1.5px; line-height: 1.1; text-align: center; text-transform: uppercase; }
        .win-popup p { font-size: clamp(13px, 2.4vh, 30px); color: #636e72; margin: 0; font-weight: 600; line-height: 1.3; text-align: center; }
        .win-popup .prize { font-size: clamp(16px, 3.2vh, 48px); font-weight: 800; color: #c8960c; padding: clamp(10px, 1.6vh, 20px) clamp(16px, 2.8vw, 40px); background: linear-gradient(135deg, rgba(244,224,77,0.25) 0%, rgba(244,197,66,0.15) 100%); border-radius: 14px; border: 3px solid rgba(244, 197, 66, 0.6); text-shadow: 0 1px 8px rgba(200,150,12,0.4); line-height: 1.2; text-align: center; white-space: normal; word-wrap: break-word; max-width: 90%; margin-top: clamp(4px, 0.8vh, 12px); }
        .slot-machine.popup-open { border-radius: 0 0 32px 32px; }



        /* Emoji Rain */
        .emoji-rain { position: fixed; top: -10%; z-index: 999; pointer-events: none; animation: emojiRainFall 3s linear forwards; }
        .emoji-rain img { width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3)); }
        @keyframes emojiRainFall {
            0% { top: -10%; opacity: 1; transform: translateX(0) rotate(0deg) scale(1); }
            50% { opacity: 1; }
            100% { top: 110%; opacity: 0; transform: translateX(var(--drift)) rotate(360deg) scale(0.7); }
        }

        /* Loading */
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.3s ease-out; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 60px; height: 60px; border: 5px solid rgba(var(--primary-rgb), 0.2); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        .loading-text { color: rgba(255, 255, 255, 0.8); font-size: 18px; font-weight: 600; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: fixed; top: 20px; right: 20px;
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s; z-index: 10001;
        }
        .fullscreen-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.4); transform: scale(1.1); }
        .fullscreen-btn:active { transform: scale(0.95); }

        body:fullscreen, body:-webkit-full-screen, body:-moz-full-screen, body:-ms-fullscreen { display: flex; justify-content: center; align-items: center; padding: 20px; }
        body:fullscreen .header, body:-webkit-full-screen .header, body:-moz-full-screen .header, body:-ms-fullscreen .header { display: none; }
        body:fullscreen .container, body:-webkit-full-screen .container, body:-moz-full-screen .container, body:-ms-fullscreen .container { max-width: 1000px; width: 100%; }
        body:fullscreen .slot-machine, body:-webkit-full-screen .slot-machine, body:-moz-full-screen .slot-machine, body:-ms-fullscreen .slot-machine { padding: 50px 40px; }
        body:fullscreen .reels-container, body:-webkit-full-screen .reels-container, body:-moz-full-screen .reels-container, body:-ms-fullscreen .reels-container { padding: 32px; gap: 32px; }
        body:fullscreen .reel, body:-webkit-full-screen .reel, body:-moz-full-screen .reel, body:-ms-fullscreen .reel { height: 300px; }
        body:fullscreen .info-display, body:-webkit-full-screen .info-display, body:-moz-full-screen .info-display, body:-ms-fullscreen .info-display { padding: 20px; margin-bottom: 40px; }
        body:fullscreen .info-display p, body:-webkit-full-screen .info-display p, body:-moz-full-screen .info-display p, body:-ms-fullscreen .info-display p { font-size: 22px; }
        body:fullscreen .spin-button, body:-webkit-full-screen .spin-button, body:-moz-full-screen .spin-button, body:-ms-fullscreen .spin-button { padding: 24px; font-size: 32px; }

        @media (max-width: 640px) {
            body { padding: 10px; }
            .header { margin-bottom: 16px; }
            .slot-machine { padding: 20px 12px; border-radius: 20px; }
            .reels-container { gap: 8px; padding: 12px; }
            .reel { height: 180px; border-radius: 12px; }
            .info-display { padding: 14px; margin-bottom: 20px; }
            .info-display p { font-size: 15px; }
            .spin-button { padding: 20px; font-size: 24px; border-radius: 12px; min-height: 60px; }
            .fullscreen-btn { width: 50px; height: 50px; top: 10px; right: 10px; font-size: 24px; border: 2px solid rgba(255, 255, 255, 0.3); }
        }

        @media (max-width: 480px) {
            body { padding: 8px; }
            .slot-machine { padding: 16px 10px; }
            .reels-container { gap: 6px; padding: 10px; }
            .reel { height: 150px; }
            .spin-button { padding: 18px; font-size: 20px; min-height: 56px; }
            .fullscreen-btn { width: 45px; height: 45px; font-size: 20px; }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            body { padding: 5px; }
            .slot-machine { padding: 12px 15px; }
            .reels-container { margin-bottom: 15px; padding: 10px; }
            .reel { height: 140px; }
            .info-display { margin-bottom: 12px; padding: 8px; }
            .info-display p { font-size: 12px; }
            .spin-button { padding: 12px; font-size: 18px; min-height: 48px; }
            .fullscreen-btn { top: 8px; right: 8px; width: 40px; height: 40px; }
        }

        @media (max-width: 768px) {
            html, body { overflow: hidden; height: 100%; }
            html { overflow-x: hidden; }
            body { overflow-x: hidden; width: 100vw; }
            .container { max-width: 100vw; width: 100%; max-height: 100vh; }
            button, .btn { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
            .slot-machine, .reel, .spin-button { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
            .fullscreen-btn { display: none !important; }
            .win-popup.show { max-height: clamp(80px, 12vh, 130px); padding: clamp(10px, 1.5vh, 20px) clamp(12px, 2vw, 20px); }
            .win-popup .emoji { width: clamp(36px, 6vh, 60px); height: clamp(36px, 6vh, 60px); font-size: clamp(26px, 4vh, 50px); padding-right: 8px; }
            .win-popup h1 { font-size: clamp(15px, 2.5vh, 28px); }
            .win-popup p { font-size: clamp(10px, 1.8vh, 18px); }
            .win-popup .prize { font-size: clamp(10px, 1.8vh, 20px); padding: 6px 10px; max-width: 40%; }
        }

        @media (max-width: 375px) {
            .slot-machine { padding: 15px 10px !important; }
            .reels-container { gap: 6px !important; padding: 10px !important; }
            .reel { height: 150px !important; }
            .spin-button { font-size: 20px !important; padding: 18px !important; }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .slot-machine { padding: 15px 10px; }
            .reels-container { max-height: 50vh; }
            .reel { height: auto; max-height: 40vh; }
            .info-display { padding: 10px; margin-bottom: 10px; }
            .spin-button { padding: 15px; font-size: 20px; }
        }

        @media (max-width: 768px) {
            body.mobile-fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
            body.mobile-fullscreen .header { display: none !important; }
            body.mobile-fullscreen .prize-legend { display: none !important; }
            body.mobile-fullscreen .container { max-height: 100vh; height: 100vh; display: flex; align-items: center; justify-content: center; padding: 10px; }
            body.mobile-fullscreen .slot-machine { max-height: 100%; display: flex; flex-direction: column; justify-content: center; }
            body.mobile-fullscreen .reels-container { flex: 1; display: flex; align-items: center; max-height: 60vh; }
            body.mobile-fullscreen .reel { height: auto; max-height: 100%; }
            body.mobile-fullscreen .info-display { margin-bottom: 15px; }
            body.mobile-fullscreen .spin-button { font-size: 28px; padding: 25px; margin-top: 15px; }
            body.mobile-fullscreen .fullscreen-btn { width: 60px; height: 60px; font-size: 30px; z-index: 10001; }
        }

        @media (min-aspect-ratio: 9/16) and (orientation: portrait),
               (max-aspect-ratio: 9/16) and (orientation: portrait) {
            html, body { width: 100vw; height: 100vh; overflow: hidden; }
            body { display: flex; align-items: center; justify-content: center; padding-top: 0; }
            .container { width: 100%; max-width: 100vw; display: flex; flex-direction: column; padding: 0 3vw 3vh 3vw; }
            .header { flex-shrink: 0; margin-bottom: 2vh; }
            .prize-legend { flex-shrink: 0; margin: 1.5vh 0; }
            .slot-machine { flex-shrink: 0; margin: 1vh 0; }
            .info-display { flex-shrink: 0; margin: 2vh 0 1.5vh 0; }
            .fullscreen-btn { display: none; }
            .win-popup {
                position: relative !important; top: auto !important; left: auto !important; transform: none !important;
                max-height: 0 !important; overflow: hidden; opacity: 0; pointer-events: none;
                width: 100% !important; max-width: 100% !important;
                padding: 0 3vw !important; margin: 0 !important; z-index: 100;
                background: linear-gradient(135deg, #ffffff, #f8f9fa);
                border-radius: 20px 20px 0 0; border: 3px solid #f4e04d; border-bottom: none;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
                display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 2vw;
                transition: max-height 0.45s cubic-bezier(0.34,1.4,0.64,1), opacity 0.35s ease, padding 0.35s ease;
            }
            .win-popup.show { max-height: 18vh !important; opacity: 1; pointer-events: auto; padding: 2vh 3vw !important; transform: none !important; }
            .win-popup > * { opacity: 0; transition: opacity 0.3s ease 0.15s; }
            .win-popup.show > * { opacity: 1; }
            .slot-machine.popup-open { border-radius: 0 0 32px 32px !important; }
            .spin-button { padding: 2.5vh 0; font-size: 3.5vh; border-radius: 15px; }
            .info-display p { font-size: 2.2vh; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading your lucky spin...</div>
    </div>

    <button class="fullscreen-btn" id="fullscreen-btn" title="Toggle Fullscreen">‚õ∂</button>

    <div class="container" id="main-container">
        <div class="header">
            <h1>
                <span class="animated-logo">CHICKILICIOUS</span>
                <span class="lucky-spin-text">
                    <span class="emoji">üé∞</span>
                    <span class="text"> LUCKY SPIN</span>
                </span>
            </h1>
            <p>Try your luck and win amazing prizes!</p>
        </div>

        <div class="prize-legend" id="prize-legend">
            <div class="layout-image-container" id="legend-layout-container">
                <img id="legend-layout-img" src="" alt="">
            </div>
        </div>

        <!-- WIN POPUP BANNER ‚Äî ABOVE the machine -->
        <div class="win-popup" id="popup">
            <div class="emoji">üéâ</div>
            <div class="win-popup-content">
                <h1 id="popup-title">CONGRATULATIONS!</h1>
                <p id="popup-message">You won a prize!</p>
            </div>
            <div class="prize" id="popup-prize">üéÅ Mystery Prize</div>
        </div>

        <div class="slot-machine" id="slot-machine">
            <div class="machine-body-overlay" id="machine-body-overlay"></div>

            <div class="layout-image-container" id="machine-layout-container">
                <img id="machine-layout-img" src="" alt="">
            </div>

            <div class="reels-container">
                <div class="reel">
                    <div class="reel-strip" id="reel1"></div>
                    <div class="reel-mask"></div>
                    <div class="reel-glass"></div>
                </div>
                <div class="reel">
                    <div class="reel-strip" id="reel2"></div>
                    <div class="reel-mask"></div>
                    <div class="reel-glass"></div>
                </div>
                <div class="reel">
                    <div class="reel-strip" id="reel3"></div>
                    <div class="reel-mask"></div>
                    <div class="reel-glass"></div>
                </div>
            </div>

            <div class="info-display">
                <p id="info-text">Press SPIN to play!</p>
            </div>

            <button class="spin-button" id="spin-btn">
                <span id="btn-text">SPIN NOW</span>
            </button>

        </div>
    </div>

    <script>
        // ================================================
        //  SERVER FETCH
        // ================================================
        const SERVER_URLS = [
            window.location.origin,
            'http://localhost:3000',
            'http://192.168.50.146:3000'
        ];

        async function fetchFromServer(endpoint) {
            for (const baseUrl of SERVER_URLS) {
                try {
                    console.log(`Trying: ${baseUrl}${endpoint}`);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    const res = await Promise.race([
                        fetch(`${baseUrl}${endpoint}`, { method: 'GET', headers: { 'Accept': 'application/json' }, signal: controller.signal }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Fetch timeout')), 3000))
                    ]);
                    clearTimeout(timeoutId);
                    if (res && res.ok) {
                        try {
                            const text = await res.text();
                            if (!text || text === 'null') { console.log(`‚úó Empty from ${baseUrl}`); continue; }
                            const data = JSON.parse(text);
                            console.log(`‚úì Success from ${baseUrl}`, endpoint);
                            return data;
                        } catch (parseError) { console.log(`‚úó Parse error from ${baseUrl}`); continue; }
                    }
                } catch (e) { console.log(`‚úó Failed from ${baseUrl}: ${e.message}`); }
            }
            console.log(`All URLs failed for ${endpoint}, using defaults`);
            return null;
        }

        // ================================================
        //  CYLINDER CONFIG
        // ================================================
        const CYLINDER_SYMBOLS = 9;
        const ANGLE_STEP = 360 / CYLINDER_SYMBOLS;

        const reelStates = {
            1: { totalRotation: 0, currentFrontSlot: 0 },
            2: { totalRotation: 0, currentFrontSlot: 0 },
            3: { totalRotation: 0, currentFrontSlot: 0 }
        };

        let symbols = [];
        let duration = 2;
        let spinning = false;
        let cachedOdds = { THREE_MATCH: 10, TWO_MATCH: 25, NO_MATCH: 65 };

        // ================================================
        //  AUDIO
        // ================================================
        let _audioCtx = null;
        function getAudioCtx() {
            const AC = window.AudioContext || window.webkitAudioContext;
            if (!_audioCtx) _audioCtx = new AC();
            if (_audioCtx.state === 'suspended') _audioCtx.resume();
            return _audioCtx;
        }

        const sounds = { spin: null, win: null, jackpot: null, lose: null };

        async function initSounds() {
            sounds.spin = {
                play: function(spinDuration = 2.5) {
                    try {
                        const audioCtx = getAudioCtx();
                        const totalDuration = spinDuration + 1.2;
                        const beepCount = Math.floor(spinDuration * 12);
                        const frequencies = [440, 493, 523, 587, 659];
                        for (let i = 0; i < beepCount; i++) {
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.connect(gain); gain.connect(audioCtx.destination);
                            osc.frequency.value = frequencies[i % frequencies.length];
                            osc.type = 'sine';
                            const progress = i / beepCount;
                            const delay = Math.pow(progress, 2) * totalDuration;
                            const t = audioCtx.currentTime + delay;
                            gain.gain.setValueAtTime(0.18, t);
                            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.08);
                            osc.start(t); osc.stop(t + 0.08);
                        }
                    } catch(e) { console.log('Sound error:', e); }
                }
            };
            sounds.win = {
                play: function() {
                    try {
                        const audioCtx = getAudioCtx();
                        [523, 659, 784].forEach((freq, i) => {
                            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                            osc.connect(gain); gain.connect(audioCtx.destination);
                            osc.frequency.value = freq; osc.type = 'sine';
                            const t = audioCtx.currentTime + (i * 0.1);
                            gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                            osc.start(t); osc.stop(t + 0.3);
                        });
                    } catch(e) { console.log('Sound error:', e); }
                }
            };
            sounds.jackpot = {
                play: function() {
                    try {
                        const audioCtx = getAudioCtx();
                        [523, 659, 784, 1047].forEach((freq, i) => {
                            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                            osc.connect(gain); gain.connect(audioCtx.destination);
                            osc.frequency.value = freq; osc.type = 'triangle';
                            const t = audioCtx.currentTime + (i * 0.15);
                            gain.gain.setValueAtTime(0.25, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
                            osc.start(t); osc.stop(t + 0.4);
                        });
                    } catch(e) { console.log('Sound error:', e); }
                }
            };
            sounds.lose = {
                play: function() {
                    try {
                        const audioCtx = getAudioCtx();
                        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                        osc.connect(gain); gain.connect(audioCtx.destination);
                        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.5);
                        osc.type = 'sawtooth';
                        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                        osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.5);
                    } catch(e) { console.log('Sound error:', e); }
                }
            };
        }

        // ================================================
        //  PRIZE CONFIG
        // ================================================
        const prizes = {
            THREE_MATCH: { title: 'JACKPOT!', message: 'All symbols matched! üéä', prize: 'üèÜ GRAND PRIZE' },
            TWO_MATCH:   { title: 'YOU WIN!', message: 'Two symbols matched!',   prize: 'üéÅ SPECIAL PRIZE' },
            NO_MATCH:    { title: 'ALMOST!',  message: 'Better luck next time!', prize: 'üé´ CONSOLATION PRIZE' }
        };

        // ================================================
        //  3D CYLINDER ‚Äî FILL REEL
        // ================================================
        function fillReel(stripEl, targetSymbol = null, targetSlotIndex = 0) {
            stripEl.innerHTML = '';

            const reel = stripEl.closest('.reel');
            const reelHeight = reel.offsetHeight;

            const symbolHeight = reelHeight / 3;
            const radius = (symbolHeight * CYLINDER_SYMBOLS) / (2 * Math.PI);

            reel.style.perspective = `${radius * 4}px`;

            const fontSize = Math.min(symbolHeight * 0.62, 100);

            for (let i = 0; i < CYLINDER_SYMBOLS; i++) {
                const div = document.createElement('div');
                div.className = 'reel-symbol';

                const sym = (i === targetSlotIndex && targetSymbol)
                    ? targetSymbol
                    : symbols[Math.floor(Math.random() * symbols.length)];

                if (sym && sym.startsWith('data:image')) {
                    const img = document.createElement('img');
                    img.src = sym;
                    div.appendChild(img);
                } else {
                    div.textContent = sym || '?';
                }

                const angle = -i * ANGLE_STEP;
                div.style.height    = symbolHeight + 'px';
                div.style.top       = (-symbolHeight / 2) + 'px';
                div.style.fontSize  = fontSize + 'px';
                div.style.transform = `rotateX(${angle}deg) translateZ(${radius}px)`;

                stripEl.appendChild(div);
            }

            stripEl.dataset.symbolHeight = symbolHeight;
            stripEl.dataset.radius       = radius;
        }

        function updateSlot(stripEl, slotIndex, symbol) {
            const slot = stripEl.querySelectorAll('.reel-symbol')[slotIndex];
            if (!slot) return;
            slot.innerHTML = '';
            if (symbol && symbol.startsWith('data:image')) {
                const img = document.createElement('img'); img.src = symbol; slot.appendChild(img);
            } else {
                slot.textContent = symbol || '?';
            }
        }

        function refreshHiddenSlots(stripEl, currentFrontSlot, targetSymbol, targetSlot) {
            for (let j = 2; j < CYLINDER_SYMBOLS; j++) {
                const slotIndex = (currentFrontSlot + j) % CYLINDER_SYMBOLS;
                const sym = (slotIndex === targetSlot)
                    ? targetSymbol
                    : symbols[Math.floor(Math.random() * symbols.length)];
                updateSlot(stripEl, slotIndex, sym);
            }
        }

        // ================================================
        //  EMOJI RAIN
        // ================================================
        function createEmojiRain() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'emoji-rain';
                    emoji.style.left = Math.random() * 100 + '%';
                    const drift = (Math.random() - 0.5) * 200;
                    emoji.style.setProperty('--drift', drift + 'px');
                    emoji.style.animationDuration = (Math.random() * 1.5 + 2) + 's';
                    emoji.style.animationDelay = Math.random() * 0.5 + 's';
                    const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                    if (randomSymbol.startsWith('data:image')) {
                        const img = document.createElement('img'); img.src = randomSymbol; emoji.appendChild(img);
                    } else {
                        emoji.textContent = randomSymbol;
                        emoji.style.fontSize = '70px';
                    }
                    document.body.appendChild(emoji);
                    emoji.addEventListener('animationend', () => emoji.remove());
                }, i * 40);
            }
        }

        // ================================================
        //  SPIN LOGIC (extracted for reuse)
        // ================================================
        function triggerSpin() {
            const spinBtn = document.getElementById('spin-btn');
            if (spinning) return;
            getAudioCtx();
            spinning = true;
            spinBtn.classList.add('disabled');

            const btnText = document.getElementById('btn-text');
            btnText.innerHTML = 'SPINNING <span class="spinner-icon">‚ö°</span>';
            document.getElementById('info-text').textContent = 'Good luck! üçÄ';

            const odds = cachedOdds;
            const currentDuration = duration;

            const r = Math.random() * 100;
            let result = 'NO_MATCH';
            if (r < odds.THREE_MATCH) result = 'THREE_MATCH';
            else if (r < odds.THREE_MATCH + odds.TWO_MATCH) result = 'TWO_MATCH';

            const baseSymbol = symbols[Math.floor(Math.random() * symbols.length)];
            const targets = [baseSymbol, baseSymbol, baseSymbol];
            if (result === 'TWO_MATCH') {
                targets[2] = symbols.find(s => s !== baseSymbol) || symbols[0];
            } else if (result === 'NO_MATCH') {
                targets[1] = symbols.find(s => s !== baseSymbol) || symbols[0];
                targets[2] = symbols.find(s => s !== baseSymbol && s !== targets[1]) || symbols[1];
            }

            const landingSlots = {};

            [1, 2, 3].forEach(reelIndex => {
                const stripEl = document.getElementById('reel' + reelIndex);
                const reel = stripEl.closest('.reel');
                const state = reelStates[reelIndex];

                setTimeout(() => {
                    const hiddenStart = (state.currentFrontSlot + Math.floor(CYLINDER_SYMBOLS / 2)) % CYLINDER_SYMBOLS;
                    const targetSlot = (hiddenStart + Math.floor(Math.random() * 2)) % CYLINDER_SYMBOLS;
                    landingSlots[reelIndex] = targetSlot;

                    refreshHiddenSlots(stripEl, state.currentFrontSlot, targets[reelIndex - 1], targetSlot);

                    if (reelIndex === 1 && sounds.spin) sounds.spin.play(currentDuration);

                    reel.classList.add('active-spin');

                    const targetAngleDeg = targetSlot * ANGLE_STEP;
                    const currentAngleDeg = ((state.totalRotation % 360) + 360) % 360;
                    let delta = ((targetAngleDeg - currentAngleDeg) + 360) % 360;
                    if (delta < ANGLE_STEP * 2) delta += 360;

                    const minSpins = 3;
                    const newTotalRotation = state.totalRotation + (minSpins * 360) + delta;

                    stripEl.style.transition = `transform ${currentDuration}s cubic-bezier(0.12, 0.0, 0.18, 1)`;
                    stripEl.style.transform = `rotateX(${newTotalRotation}deg)`;

                    state.totalRotation = newTotalRotation;
                    state.currentFrontSlot = targetSlot;

                }, reelIndex * 400);

                setTimeout(() => {
                    reel.classList.remove('active-spin');
                    reel.classList.add('reveal-flash');
                    setTimeout(() => reel.classList.remove('reveal-flash'), 500);
                }, currentDuration * 1000 + reelIndex * 400 + 100);
            });

            const totalDelay = (currentDuration * 1000) + (3 * 400) + 700;

            setTimeout(() => {
                spinning = false;
                spinBtn.classList.remove('disabled');
                btnText.textContent = 'SPIN AGAIN';
                document.getElementById('info-text').textContent = 'Press SPIN to play!';

                const highlightReels = result === 'THREE_MATCH' ? [1,2,3] : result === 'TWO_MATCH' ? [1,2] : [];
                highlightReels.forEach(i => {
                    const stripEl = document.getElementById('reel' + i);
                    const slot = landingSlots[i];
                    const symbolEls = stripEl.querySelectorAll('.reel-symbol');
                    if (symbolEls[slot]) {
                        symbolEls[slot].classList.add('winning');
                        setTimeout(() => symbolEls[slot].classList.remove('winning'), 1000);
                    }
                });

                const prizeConfig = prizes[result];
                const popup = document.getElementById('popup');
                const emojiContainer = popup.querySelector('.emoji');
                emojiContainer.innerHTML = '';

                const iconToShow = (result !== 'NO_MATCH') ? targets[0] : 'üòÖ';
                if (iconToShow.startsWith('data:image')) {
                    const img = document.createElement('img'); img.src = iconToShow; emojiContainer.appendChild(img);
                } else {
                    emojiContainer.textContent = iconToShow;
                }

                document.getElementById('popup-title').textContent  = prizeConfig.title;
                document.getElementById('popup-message').textContent = prizeConfig.message;
                document.getElementById('popup-prize').textContent   = prizeConfig.prize;
                popup.classList.add('show');
                document.getElementById('slot-machine').classList.add('popup-open');

                if (result === 'THREE_MATCH' && sounds.jackpot) sounds.jackpot.play();
                else if (result === 'TWO_MATCH' && sounds.win) sounds.win.play();
                else if (sounds.lose) sounds.lose.play();

                if (result === 'THREE_MATCH') createEmojiRain();

                setTimeout(() => {
                    popup.classList.remove('show');
                    document.getElementById('slot-machine').classList.remove('popup-open');
                }, 4000);

            }, totalDelay);
        }

        // ================================================
        //  SPIN BUTTON CLICK
        // ================================================
        document.getElementById('spin-btn').onclick = function () {
            triggerSpin();
        };

        // ================================================
        //  SPACEBAR SHORTCUT
        // ================================================
        document.addEventListener('keydown', function (e) {
            // Only trigger on Space, and not when user is typing in an input
            if (e.code === 'Space' || e.key === ' ') {
                const tag = document.activeElement && document.activeElement.tagName;
                if (tag === 'INPUT' || tag === 'TEXTAREA') return;
                e.preventDefault(); // prevent page scroll
                triggerSpin();
            }
        });

        // ================================================
        //  SETTINGS LOADERS
        // ================================================
        async function loadSettings() {
            try {
                const serverData = await Promise.race([fetchFromServer('/api/load/symbols'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (serverData && serverData.length > 0) {
                    symbols = serverData.map(s => s.image || s.emoji);
                    console.log('Loaded symbols from server:', symbols.length);
                } else {
                    symbols = ['üçí', '7Ô∏è‚É£', 'üçã', 'üçä', '‚≠ê', 'üíé', 'üîî', 'üçÄ'];
                }
            } catch (e) {
                console.log('Failed to load symbols, using defaults:', e.message);
                symbols = ['üçí', '7Ô∏è‚É£', 'üçã', 'üçä', '‚≠ê', 'üíé', 'üîî', 'üçÄ'];
            }

            try {
                const serverOdds = await Promise.race([fetchFromServer('/api/load/probabilities'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (serverOdds) { cachedOdds = serverOdds; console.log('Loaded odds from server:', cachedOdds); }
            } catch (e) { console.log('Failed to load odds:', e); }

            try {
                const serverSpeed = await Promise.race([fetchFromServer('/api/load/spinSpeed'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (serverSpeed) { duration = parseFloat(serverSpeed); console.log('Loaded speed:', duration); }
            } catch (e) { console.log('Failed to load speed:', e); }

            await loadBackground();
            await loadColorTheme();
        }

        async function loadBackground() {
            try {
                const bgData = await Promise.race([fetchFromServer('/api/load/background'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (!bgData) return;
                const body = document.body;
                if (bgData.type === 'color') body.style.background = bgData.value;
                else if (bgData.type === 'gradient') body.style.background = bgData.value;
                else if (bgData.type === 'image') { body.style.backgroundImage = `url(${bgData.value})`; body.style.backgroundSize = 'cover'; body.style.backgroundPosition = 'center'; body.style.backgroundAttachment = 'fixed'; }
            } catch (e) { console.log('Failed to load background:', e.message); }
        }

        async function loadColorTheme() {
            try {
                const themeData = await Promise.race([fetchFromServer('/api/load/colorTheme'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (!themeData) return;
                const root = document.documentElement;
                if (themeData.spinBtnBg) {
                    root.style.setProperty('--primary-color', themeData.spinBtnBg);
                    root.style.setProperty('--primary-light', themeData.spinBtnBg);
                    const hex = themeData.spinBtnBg.replace('#', '');
                    const r = parseInt(hex.substring(0,2),16), g = parseInt(hex.substring(2,4),16), b = parseInt(hex.substring(4,6),16);
                    root.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
                }
                if (themeData.reelBg) root.style.setProperty('--reel-bg-color', themeData.reelBg);
                const title = document.querySelector('.animated-logo'); if (title && themeData.titleColor) title.style.color = themeData.titleColor;
                const subtitle = document.querySelector('.header p'); if (subtitle && themeData.subtitleColor) subtitle.style.color = themeData.subtitleColor;
                document.querySelectorAll('.legend-prize').forEach(el => { if (themeData.prizeBoxText) el.style.color = themeData.prizeBoxText; });
                const slotMachine = document.querySelector('.slot-machine'); if (slotMachine && themeData.slotBoxBg) slotMachine.style.background = themeData.slotBoxBg;
                if (themeData.pageBgColor) document.body.style.background = themeData.pageBgColor;
                const reelsContainer = document.querySelector('.reels-container'); if (reelsContainer && themeData.reelFrameColor) reelsContainer.style.background = themeData.reelFrameColor;
                const spinBtn = document.querySelector('.spin-button');
                if (spinBtn) {
                    if (themeData.spinBtnBg) spinBtn.style.background = `linear-gradient(135deg, ${themeData.spinBtnBg} 0%, ${themeData.spinBtnBg} 100%)`;
                    if (themeData.spinBtnText) spinBtn.style.color = themeData.spinBtnText;
                }
                const infoText = document.getElementById('info-text'); if (infoText && themeData.instructionText) infoText.style.color = themeData.instructionText;
            } catch (e) { console.log('Color theme loading error:', e.message); }
        }

        async function loadLayouts() {
            try {
                const legendLayout = await Promise.race([fetchFromServer('/api/load/layout-legend'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (legendLayout) { document.documentElement.style.setProperty('--legend-layout', `url(${legendLayout})`); document.querySelector('.prize-legend').classList.add('has-layout'); }

                const machineLayout = await Promise.race([fetchFromServer('/api/load/layout-machine'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (machineLayout) { document.documentElement.style.setProperty('--machine-layout', `url(${machineLayout})`); document.querySelector('.slot-machine').classList.add('has-layout'); }

                const machineBodyLayout = await Promise.race([fetchFromServer('/api/load/layout-machine-body'), new Promise(r => setTimeout(() => r(null), 800))]);
                if (machineBodyLayout) {
                    const overlay = document.getElementById('machine-body-overlay');
                    if (overlay) {
                        overlay.style.backgroundImage = `url(${machineBodyLayout})`;
                        overlay.classList.add('active');
                        document.getElementById('slot-machine').style.background = 'transparent';
                        document.getElementById('slot-machine').style.backdropFilter = 'none';
                        document.getElementById('slot-machine').style.border = 'none';
                        document.getElementById('slot-machine').style.boxShadow = 'none';
                    }
                }
            } catch (e) { console.log('Failed to load layouts:', e.message); }
        }

        async function loadFullTemplate() {
            try {
                const templateMode = await Promise.race([fetchFromServer('/api/load/template-mode'), new Promise(r => setTimeout(() => r(null), 2000))]);
                if (templateMode === 'true') {
                    const templateImage = await Promise.race([fetchFromServer('/api/load/full-template'), new Promise(r => setTimeout(() => r(null), 800))]);
                    if (templateImage) { document.body.style.backgroundImage = `url(${templateImage})`; document.body.classList.add('template-mode'); console.log('Full template mode enabled'); }
                }
            } catch (e) { console.log('Failed to load template:', e.message); }
        }

        function populatePrizeLegend() {
            const legendContainer = document.getElementById('prize-legend');
            if (!legendContainer || symbols.length === 0) return;
            legendContainer.innerHTML = '';
            const symbol1 = symbols[0];
            const symbol2 = symbols.length > 1 ? symbols[1] : symbols[0];
            const symbol3 = symbols.length > 2 ? symbols[2] : (symbols.length > 1 ? symbols[1] : symbols[0]);

            function createSymbolElement(symbol) {
                const symbolDiv = document.createElement('div');
                symbolDiv.className = 'legend-symbol';
                if (symbol.startsWith('data:image')) { const img = document.createElement('img'); img.src = symbol; symbolDiv.appendChild(img); }
                else symbolDiv.textContent = symbol;
                return symbolDiv;
            }

            const legendItems = [
                { symbols: [symbol1, symbol1, symbol1], label: prizes.THREE_MATCH.prize },
                { symbols: [symbol2, symbol2, symbol3], label: prizes.TWO_MATCH.prize },
                { symbols: [symbol1, symbol2, symbol3], label: 'No Prize' }
            ];

            legendItems.forEach(item => {
                const legendItem = document.createElement('div'); legendItem.className = 'legend-item';
                const symbolsDiv = document.createElement('div'); symbolsDiv.className = 'legend-symbols';
                item.symbols.forEach(symbol => symbolsDiv.appendChild(createSymbolElement(symbol)));
                const arrow = document.createElement('span'); arrow.className = 'legend-arrow'; arrow.textContent = '‚Üí';
                const prizeText = document.createElement('span'); prizeText.className = 'legend-prize'; prizeText.textContent = item.label;
                if (item.label === 'No Prize') { prizeText.style.color = 'rgba(255, 255, 255, 0.5)'; prizeText.style.textDecoration = 'line-through'; }
                legendItem.appendChild(symbolsDiv); legendItem.appendChild(arrow); legendItem.appendChild(prizeText);
                legendContainer.appendChild(legendItem);
            });
        }

        function splitTextToChars(selector) {
            const el = document.querySelector(selector);
            if (!el) return [];
            const text = el.textContent.trim();
            el.innerHTML = '';
            const chars = [];
            for (const ch of text) {
                const span = document.createElement('span');
                span.className = 'char';
                span.textContent = ch === ' ' ? '\u00A0' : ch;
                el.appendChild(span);
                chars.push(span);
            }
            return chars;
        }

        // ================================================
        //  INIT
        // ================================================
        window.onload = async () => {
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                document.body.addEventListener('touchmove', (e) => {
                    if (e.target === document.body || e.target === document.documentElement) e.preventDefault();
                }, { passive: false });
                document.addEventListener('gesturestart', (e) => e.preventDefault());
                if (window.innerHeight > window.innerWidth) {
                    document.body.style.paddingTop = 'env(safe-area-inset-top)';
                    document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
                }
            }

            await Promise.all([loadSettings(), loadFullTemplate(), loadLayouts(), initSounds()]);

            populatePrizeLegend();

            const logoChars = splitTextToChars('.animated-logo');
            if (logoChars.length > 0) {
                anime.timeline({ loop: true })
                    .add({
                        targets: '.animated-logo .char',
                        translateY: [
                            { value: '-1rem', duration: 600, easing: 'easeOutExpo' },
                            { value: '0rem', duration: 800, delay: 100, easing: 'easeOutBounce' }
                        ],
                        rotate: ['-1turn', '0turn'],
                        delay: anime.stagger(50),
                        easing: 'easeInOutCirc'
                    })
                    .add({}, 2500);
            }

            [1, 2, 3].forEach(i => {
                const stripEl = document.getElementById('reel' + i);
                fillReel(stripEl, null, 0);
                stripEl.style.transition = 'none';
                stripEl.style.transform  = 'rotateX(0deg)';
                reelStates[i].totalRotation   = 0;
                reelStates[i].currentFrontSlot = 0;
            });

            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            let mobileFullscreenActive = false;

            fullscreenBtn.addEventListener('click', () => {
                if (isMobile && window.innerWidth <= 768) {
                    mobileFullscreenActive = !mobileFullscreenActive;
                    if (mobileFullscreenActive) {
                        document.body.classList.add('mobile-fullscreen');
                        fullscreenBtn.textContent = '‚úï';
                        if (screen.orientation && screen.orientation.lock) screen.orientation.lock('portrait').catch(() => {});
                        const elem = document.documentElement;
                        if (elem.requestFullscreen) elem.requestFullscreen().catch(() => {});
                        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen().catch(() => {});
                    } else {
                        document.body.classList.remove('mobile-fullscreen');
                        fullscreenBtn.textContent = '‚õ∂';
                        if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
                        if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
                        else if (document.webkitExitFullscreen) document.webkitExitFullscreen().catch(() => {});
                    }
                } else {
                    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                        const elem = document.documentElement;
                        if (elem.requestFullscreen) elem.requestFullscreen();
                        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                        else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
                        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
                        fullscreenBtn.textContent = '‚úï';
                    } else {
                        if (document.exitFullscreen) document.exitFullscreen();
                        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                        else if (document.msExitFullscreen) document.msExitFullscreen();
                        fullscreenBtn.textContent = '‚õ∂';
                    }
                }
            });

            document.addEventListener('fullscreenchange', updateFullscreenButton);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
            document.addEventListener('mozfullscreenchange', updateFullscreenButton);
            document.addEventListener('MSFullscreenChange', updateFullscreenButton);

            function updateFullscreenButton() {
                if (!isMobile || window.innerWidth > 768) {
                    fullscreenBtn.textContent = (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) ? '‚úï' : '‚õ∂';
                }
            }

            window.addEventListener('popstate', () => {
                if (mobileFullscreenActive) {
                    document.body.classList.remove('mobile-fullscreen');
                    fullscreenBtn.textContent = '‚õ∂';
                    mobileFullscreenActive = false;
                }
            });

            document.getElementById('loading').classList.add('hidden');
        };
    </script>
</body>
</html>